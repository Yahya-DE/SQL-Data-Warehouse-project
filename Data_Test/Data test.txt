/*
============================================================
 Script Name : data_quality_tests.sql
 Layer       : Silver
 Purpose     :
    - Perform data quality checks on Silver layer tables
    - Identify duplicates, nulls, invalid values, and mismatches
    - Verify consistency and basic business rules
 Notes:
    - Focus on CRM, ERP, and product tables
    - Intended for manual review of data issues before analytics
============================================================
*/

-- ===============================
-- Table: crm_cust_info
-- ===============================

-- Check duplicates by cst_id
SELECT cst_id, COUNT(*) AS duplicate_count
FROM Silver.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1;

-- Check null values in primary key
SELECT *
FROM Silver.crm_cust_info
WHERE cst_id IS NULL;

-- Check duplicates by cst_key
SELECT cst_key
FROM Silver.crm_cust_info
GROUP BY cst_key, cst_id
HAVING COUNT(*) > 1;

-- Check nulls in cst_key
SELECT *
FROM Silver.crm_cust_info
WHERE cst_key IS NULL;

-- Check first name formatting
SELECT *
FROM Silver.crm_cust_info
WHERE LEN(cst_firstname) != LEN(TRIM(cst_firstname)) OR cst_firstname IS NULL;

-- Check last name formatting
SELECT *
FROM Silver.crm_cust_info
WHERE LEN(cst_lastname) != LEN(TRIM(cst_lastname)) OR cst_lastname IS NULL;

-- Check marital status distinct values
SELECT DISTINCT cst_marital_status
FROM Silver.crm_cust_info;

-- Check gender distinct values
SELECT DISTINCT cst_gndr
FROM Silver.crm_cust_info;

-- Check creation date validity
SELECT *
FROM Silver.crm_cust_info
WHERE cst_create_date IS NULL
   OR cst_create_date NOT BETWEEN '1970-01-01' AND CAST(GETDATE() AS DATE);

-- ===============================
-- Table: crm_prd_info
-- ===============================

-- Check nulls and duplicates for prd_id
SELECT prd_id, COUNT(*) AS duplicate_count
FROM Silver.crm_prd_info
WHERE prd_id IS NULL
GROUP BY prd_id
HAVING COUNT(*) > 1;

-- Check join consistency with sales details
SELECT p.prd_key, s.sls_prd_key
FROM Silver.crm_prd_info p
INNER JOIN Bronze.crm_sales_details s
ON p.prd_key = s.sls_prd_key;

-- Check product name formatting
SELECT prd_nm
FROM Silver.crm_prd_info
WHERE LEN(prd_nm) != LEN(TRIM(prd_nm)) OR prd_nm IS NULL;

-- Check product cost
SELECT prd_cost
FROM Silver.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

-- Check product line distinct values
SELECT DISTINCT prd_line
FROM Silver.crm_prd_info;

-- Check start and end date consistency
SELECT prd_start_dt, prd_end_dt
FROM Silver.crm_prd_info
WHERE prd_start_dt > prd_end_dt;

-- ===============================
-- Table: crm_sales_details
-- ===============================

-- Check nulls in order number
SELECT sls_ord_num
FROM Silver.crm_sales_details
WHERE sls_ord_num IS NULL;

-- Check date logic
SELECT *
FROM Silver.crm_sales_details
WHERE sls_order_dt > sls_ship_dt
   OR sls_ship_dt > sls_due_dt;

-- Check date length (should match YYYY-MM-DD)
SELECT *
FROM Silver.crm_sales_details
WHERE LEN(sls_order_dt) != 10
   OR LEN(sls_ship_dt) != 10
   OR LEN(sls_due_dt) != 10;

-- Check sales, quantity, price validity
SELECT DISTINCT sls_sales, sls_quantity, sls_price
FROM Silver.crm_sales_details
WHERE sls_price <= 0 OR sls_price IS NULL
   OR sls_quantity <= 0 OR sls_quantity IS NULL
   OR sls_sales <= 0 OR sls_sales IS NULL;

-- Check math consistency
SELECT sls_sales, sls_quantity, sls_price
FROM Silver.crm_sales_details
WHERE sls_quantity * sls_price != sls_sales;

-- ===============================
-- Table: erp_cust_az12
-- ===============================

-- Check join with CRM
SELECT COUNT(*)
FROM Silver.erp_cust_az12 c
LEFT JOIN Silver.crm_cust_info ci
ON c.CID = ci.cst_key
WHERE ci.cst_key IS NULL;

-- Check duplicates
SELECT cid, COUNT(*) AS duplicate_count
FROM Silver.erp_cust_az12
GROUP BY cid
HAVING COUNT(*) > 1;

-- Check nulls
SELECT *
FROM Silver.erp_cust_az12
WHERE cid IS NULL;

-- Check birth date
SELECT *
FROM Silver.erp_cust_az12
WHERE b_date > GETDATE();

-- Check gender distinct values
SELECT DISTINCT gen
FROM Silver.erp_cust_az12;

-- ===============================
-- Table: erp_loc_a101
-- ===============================

-- Check join with CRM
SELECT COUNT(*)
FROM Silver.erp_loc_a101 la
LEFT JOIN Silver.crm_cust_info c
ON la.CID = c.cst_key
WHERE c.cst_key IS NULL;

-- Check duplicates
SELECT CID, COUNT(*) AS duplicate_count
FROM Silver.erp_loc_a101
GROUP BY CID
HAVING COUNT(*) > 1;

-- Check nulls
SELECT *
FROM Silver.erp_loc_a101
WHERE CID IS NULL;

-- Check country distinct values
SELECT DISTINCT CNTRY
FROM Silver.erp_loc_a101;

-- ===============================
-- Table: erp_px_cat_g1v2
-- ===============================

-- Check join with products
SELECT COUNT(*)
FROM Silver.erp_px_cat_g1v2 pc
LEFT JOIN Silver.crm_prd_info p
ON pc.ID = p.prd_cat_key
WHERE p.prd_cat_key IS NULL;

-- Check duplicates
SELECT ID, COUNT(*) AS duplicate_count
FROM Silver.erp_px_cat_g1v2
GROUP BY ID
HAVING COUNT(*) > 1;

-- Check nulls
SELECT *
FROM Silver.erp_px_cat_g1v2
WHERE ID IS NULL;

-- Check category distinct values
SELECT DISTINCT CAT
FROM Silver.erp_px_cat_g1v2;

-- Check subcategory distinct values
SELECT DISTINCT sup_cat
FROM Silver.erp_px_cat_g1v2;

-- Check maintenance distinct values
SELECT DISTINCT maintenance
FROM Silver.erp_px_cat_g1v2;